name: Publish to pub.dev

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  publish:
    runs-on: ubuntu-latest
    name: Publish Package
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Run tests
      run: flutter test
      
    - name: Analyze code
      run: flutter analyze
      
    - name: Check formatting
      run: flutter format --dry-run --set-exit-if-changed .
      
    - name: Package analysis
      run: |
        dart pub global activate pana
        dart pub global run pana --no-warning
        
    - name: Publish dry run
      run: flutter pub publish --dry-run
      
    - name: Publish to pub.dev
      uses: k-paxian/dart-package-publisher@v1.5.1
      with:
        credentialJson: ${{ secrets.CREDENTIAL_JSON }}
        flutter: true
        skipTests: true
        
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Media Picker Plus ${{ github.ref }}
        body: |
          ## ğŸš€ New Release of Media Picker Plus
          
          ### Features
          - ğŸ“¸ Pick images and videos from gallery
          - ğŸ¥ Capture photos and record videos with camera
          - ğŸ’§ Advanced watermarking for images and videos
          - ğŸ“ File picking with extension filtering
          - ğŸ”¢ Multiple selection support
          - ğŸŒ Cross-platform: Android, iOS, macOS, Web
          - ğŸ” Permission management
          - ğŸ¨ Image quality control and resizing
          
          ### Platform Support
          - âœ… **Android**: Full support with advanced features
          - âœ… **iOS**: Full support with advanced features  
          - âœ… **macOS**: Full support with advanced features
          - âœ… **Web**: Full support with HTML5 APIs
          
          ### Installation
          
          Add to your `pubspec.yaml`:
          ```yaml
          dependencies:
            media_picker_plus: ${{ github.ref_name }}
          ```
          
          ### Quick Start
          
          ```dart
          import 'package:media_picker_plus/media_picker_plus.dart';
          
          // Pick image with watermark
          final path = await MediaPickerPlus.pickImage(
            options: MediaOptions(
              watermark: 'Â© MyApp 2025',
              watermarkPosition: WatermarkPosition.bottomRight,
              imageQuality: 85,
            ),
          );
          ```
          
          ### Documentation
          
          - [API Usage Guide](https://github.com/thanhtunguet/media_picker_plus/blob/main/example/API_USAGE.md)
          - [Example App](https://github.com/thanhtunguet/media_picker_plus/tree/main/example)
          - [Changelog](https://github.com/thanhtunguet/media_picker_plus/blob/main/CHANGELOG.md)
          
          See [CHANGELOG.md](https://github.com/thanhtunguet/media_picker_plus/blob/main/CHANGELOG.md) for detailed changes.
          
        draft: false
        prerelease: false